<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.javalab.board.repository.BoardRepository">

	<!-- 게시물 목록 조회 -->
	<select id="getBoardList" resultType="BoardVo">
		SELECT 
			board_no, 
			title, 
			content, 
			member_id, 
			hit_no, 
			reg_date,  
			rating
		FROM board 
		ORDER BY reg_date DESC	
	</select>

	<!-- 게시물 목록 페이징 및 검색 -->
	<select id="getBoardListPaging" parameterType="Criteria" resultType="BoardVo">
		SELECT 
			board_no, 
			title, 
			member_id, 
			hit_no, 
			reg_date, 
			reply_group, 
			reply_order, 
			reply_indent,
			spoiler
		FROM (
			SELECT 
				board_no, 
				title, 
				member_id, 
				hit_no, 
				reg_date, 
				reply_group, 
				reply_order, 
				reply_indent,
				spoiler,
				ROW_NUMBER() OVER (ORDER BY reply_group DESC, reply_order ASC, reply_indent ASC) AS rnum
			FROM board
			<where>
				<if test="searchText != null and searchText != ''">
					title LIKE '%' || #{searchText} || '%' 
					OR content LIKE '%' || #{searchText} || '%'
				</if>
			</where>
		)
		WHERE rnum BETWEEN ((#{pageNum} - 1) * #{amount} + 1) AND (#{pageNum} * #{amount})
	</select>

	<!-- 게시물 상세 조회 -->
	<select id="getBoard" parameterType="int" resultType="BoardVo">
		SELECT 
			board_no, 
			title, 
			content, 
			member_id, 
			hit_no,
			reg_date,
			reply_group,
			reply_order,
			reply_indent,  
			rating,
			spoiler
		FROM board 
		WHERE board_no = #{boardNo}
	</select>

	<!-- 조회수 증가 -->
	<update id="increaseHitNo" parameterType="int">
		UPDATE board
		SET hit_no = hit_no + 1
		WHERE board_no = #{boardNo}
	</update>

	<!-- 전체 게시물 수 조회 -->
	<select id="getTotalBoardCount" parameterType="Criteria" resultType="int">
		SELECT COUNT(*)
		FROM BOARD
		<where>
			<if test="searchText != null">
				TITLE LIKE '%'||#{searchText}||'%' OR CONTENT LIKE '%'||#{searchText}||'%'
			</if>
		</where>
	</select>

	<!-- 게시물 등록 -->
	<insert id="insertBoard" parameterType="BoardVo">
		INSERT INTO board(
			board_no,
			title, 
			content, 
			member_id, 
			hit_no,
			reg_date,
			reply_group, 
			reply_order, 
			reply_indent,  
			rating,
			spoiler
		)
		VALUES (
			board_seq.nextval,
			#{title}, 
			#{content}, 
			#{memberId}, 
			0,
			sysdate,
			#{replyGroup},
			#{replyOrder},
			#{replyIndent},
			#{rating},
			#{spoiler}
		)
	</insert>

	<!-- 답글 순서 조정 -->
	<update id="updateReplyOrder" parameterType="BoardVo">
		UPDATE board
		SET reply_order = reply_order + 1
		WHERE reply_group = #{replyGroup} AND reply_order >= #{replyOrder}
	</update>

	<!-- 답글 등록 -->
	<insert id="insertReply" parameterType="BoardVo">
		INSERT INTO board (
			board_no, 
			title, 
			content, 
			member_id, 
			hit_no, 
			reg_date, 
			reply_group, 
			reply_order, 
			reply_indent,
			spoiler
		) VALUES (
			board_seq.NEXTVAL, 
			#{title}, 
			#{content}, 
			#{memberId}, 
			0, 
			SYSDATE, 
			#{replyGroup}, 
			#{replyOrder}, 
			#{replyIndent},
			#{spoiler}
		)
	</insert>

	<!-- 게시물 수정 -->
	<update id="updateBoard" parameterType="BoardVo">
		UPDATE board
		SET title = #{title},
			content = #{content},
			rating = #{rating}
		WHERE board_no = #{boardNo}
	</update>

	<!-- 게시물 삭제 -->
	<delete id="deleteBoard" parameterType="int">
		DELETE FROM board
		WHERE board_no = #{boardNo}
	</delete>

</mapper>
